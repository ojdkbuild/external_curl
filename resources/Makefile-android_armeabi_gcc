# Copyright 2015, alex at staticlibs.net
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

export CC := ${CMAKE_C_COMPILER}
export AR := ${CMAKE_AR}
export AS := ${CMAKE_AS}
export LD := ${CMAKE_LD}
export NM := ${CMAKE_NM}
export OBJCOPY := ${CMAKE_OBJCOPY}
export OBJDUMP := ${CMAKE_OBJDUMP}
export RANLIB := ${CMAKE_RANLIB}
export STRIP := ${CMAKE_STRIP}
export CFLAGS := ${${PROJECT_NAME}_CFLAGS}
export LDFLAGS := -L${CMAKE_LIBRARY_OUTPUT_DIRECTORY}

configure:
	@echo -- Skipping configure, it will be run during the build stage
	
build:
ifeq ($(wildcard ./curl_flag),)
	rm curl/include/curl/curlbuild.h
	cd curl && $(SH) ./buildconf
	cd curl && $(SH) ./configure \
	    --host=${CMAKE_HOST} \
	    --with-sysroot=${CMAKE_SYSROOT} \
	    --enable-static \
	    --enable-symbol-hiding \
	    --enable-http \
	    --enable-ipv6 \
	    --enable-cookies \
	    --with-zlib${${PROJECT_NAME}_ZLIB_INSTALLED_PATH} \
	    --with-ssl${${PROJECT_NAME}_OPENSSL_INSTALLED_PATH} \
	    --disable-shared \
	    --disable-ares \
	    --disable-dependency-tracking \
	    --disable-fast-install \
	    --disable-ftp \
	    --disable-file \
	    --disable-ldap \
	    --disable-ldaps \
	    --disable-rtsp \
	    --disable-proxy \
	    --disable-dict \
	    --disable-telnet \
	    --disable-tftp \
	    --disable-pop3 \
	    --disable-imap \
	    --disable-smb \
	    --disable-smtp \
	    --disable-gopher \
	    --disable-manual \
	    --disable-libcurl-option \
	    --disable-versioned-symbols \
	    --disable-threaded-resolver \
	    --disable-sspi \
	    --disable-ntlm-wb \
	    --disable-unix-sockets \
	    --disable-soname-bump \
	    --without-winssl \
	    --without-darwinssl \
	    --without-gnutls \
	    --without-polarssl \
	    --without-cyassl \
	    --without-nss \
	    --without-axtls \
	    --without-libmetalink \
	    --without-libssh2 \
	    --without-librtmp \
	    --without-winidn \
	    --without-libidn \
	    --without-nghttp2 \
	    ${${PROJECT_NAME}_DEBUG}
	cd curl && $(MAKE)
	mkdir -p ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}
	cp ./curl/lib/.libs/libcurl.a ${CMAKE_LIBRARY_OUTPUT_DIRECTORY}/libcurl.a
	touch ./curl_flag
else
	@echo "[${CMAKE_CURRENT_BINARY_DIR}/curl_flag] found, skipping build"
endif	
